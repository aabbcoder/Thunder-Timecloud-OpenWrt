# å·¥ä½œæµåç§°ï¼šç¼–è¯‘Thunder Timecloud OpenWrt 21.02.7ï¼ˆåŸºç¡€ç‰ˆï¼‰
name: Build Timecloud OpenWrt 21.02.7

# ä»…ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼Œç§»é™¤æ‰€æœ‰æ–‡ä»¶å˜æ›´è‡ªåŠ¨è§¦å‘é€»è¾‘
on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘ï¼Œæ— ä»»ä½•è‡ªåŠ¨è§¦å‘æ¡ä»¶

# ä½œä¸šé…ç½®
jobs:
  build-timecloud-21027:
    runs-on: ubuntu-22.04  # ç¼–è¯‘ç¯å¢ƒï¼ˆ22.04å…¼å®¹æ€§æœ€ä½³ï¼‰
    permissions:
      contents: write      # å…è®¸ä¸Šä¼ å›ºä»¶åˆ°Releases
      actions: read

    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä»£ç ï¼ˆå«configsé…ç½®ï¼‰
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # æ­¥éª¤2ï¼šå®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆOpenWrt 21.02.7å¿…å¤‡ï¼‰
      - name: Install Dependencies
        run: |
          sudo apt update -y && sudo apt full-upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget \
            libelf-dev libtool-bin autoconf automake texinfo patch pkg-config libglib2.0-dev
          sudo apt autoremove -y && sudo apt clean -y

      # æ­¥éª¤3ï¼šç¼“å­˜ç¼–è¯‘èµ„æºï¼ˆé¦–æ¬¡2å°æ—¶ï¼Œåç»­30åˆ†é’Ÿï¼‰
      - name: Cache Build Resources
        uses: actions/cache@v3
        with:
          path: |
            ./dl
            ./staging_dir
            ./feeds
          key: ubuntu2204-timecloud-21027-${{ hashFiles('configs/build.config') }}
          restore-keys: |
            ubuntu2204-timecloud-21027-

      # æ­¥éª¤4ï¼šæ‹‰å–OpenWrt 21.02.7å®˜æ–¹æºç ï¼ˆå›ºå®šç‰ˆæœ¬ï¼‰
      - name: Clone OpenWrt 21.02.7 Source
        run: |
          rm -rf openwrt && mkdir -p openwrt && cd openwrt
          # æ‹‰å–21.02.7 tagç‰ˆæœ¬æºç ï¼ˆç²¾å‡†åŒ¹é…ï¼‰
          git clone -b v21.02.7 --depth=1 https://github.com/openwrt/openwrt.git .
          # ä¿®å¤21.02.7è¿‡æœŸçš„feedsæºï¼ˆå…³é”®ï¼šé¿å…ç¼–è¯‘å¤±è´¥ï¼‰
          sed -i 's#src-git packages #src-git packages https://github.com/openwrt/packages.git^openwrt-21.02 #' feeds.conf.default
          sed -i 's#src-git luci #src-git luci https://github.com/openwrt/luci.git^openwrt-21.02 #' feeds.conf.default
          # æ›´æ–°æ’ä»¶æº
          ./scripts/feeds update -a

      # æ­¥éª¤5ï¼šå¯¼å…¥é…ç½®
      - name: Import Custom Config
        run: |
          cd openwrt
          # ç¼–è¯‘é…ç½®
          CONFIG_FILE="$GITHUB_WORKSPACE/configs/build.config"
          
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ ç¼–è¯‘é…ç½®ä¸å­˜åœ¨ï¼š$CONFIG_FILE"
            exit 1
          fi
          
          # å¤åˆ¶é…ç½®åˆ°æºç ç›®å½•
          cp "$CONFIG_FILE" ./.config
          
          # å¤åˆ¶é¢„ç½®çš„ UCI é…ç½®åˆ°æºç ç›®å½•
          cp -r "$GITHUB_WORKSPACE/files" ./
          
          # å®‰è£…æ’ä»¶ä¾èµ–
          ./scripts/feeds install -a
          # è‡ªåŠ¨è¡¥å…¨é…ç½®ä¾èµ–ï¼ˆé¿å…ç¼ºå¤±ç»„ä»¶ï¼‰
          make defconfig

      # æ­¥éª¤6ï¼šç¼–è¯‘å›ºä»¶ï¼ˆé€‚é…16Mé—ªå­˜ï¼‰
      - name: Build OpenWrt Firmware
        run: |
          cd openwrt
          # ä¸‹è½½ä¾èµ–åŒ…ï¼ˆé¿å…ç¼–è¯‘ä¸­æ–­ï¼‰
          make -j$(nproc) download V=s
          # å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹é‡è¯•
          make -j$(nproc) V=s || make -j1 V=s
          # åˆ—å‡ºç¼–è¯‘ç»“æœï¼ˆä¾¿äºè°ƒè¯•ï¼‰
          ls -lh bin/targets/ramips/mt7621/

      # æ­¥éª¤7ï¼šä¸Šä¼ å›ºä»¶åˆ°Artifactsï¼ˆä¸´æ—¶ä¸‹è½½ï¼Œä¿ç•™30å¤©ï¼‰
      - name: Upload to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Timecloud-21.02.7
          path: openwrt/bin/targets/ramips/mt7621/
          retention-days: 30

      # æ­¥éª¤8ï¼šä¸Šä¼ å›ºä»¶åˆ°Releasesï¼ˆæ°¸ä¹…ä¿å­˜ï¼Œä»…æ‰‹åŠ¨è§¦å‘ï¼‰
      - name: Upload to Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: Timecloud-21.02.7-${{ github.run_id }}
          name: Timecloud OpenWrt 21.02.7
          files: openwrt/bin/targets/ramips/mt7621/*.bin
          body: |
            ğŸ“¦ Thunder Timecloud å®šåˆ¶å›ºä»¶ï¼ˆ21.02.7ï¼‰
            - é€‚é…ç¡¬ä»¶ï¼š16Mé—ªå­˜ + 128Må†…å­˜
            - é¢„è£…æ ¸å¿ƒï¼šTransmission + Samba4 + ä¸­æ–‡LuCI
            - ç‰¹ç‚¹ï¼šç²¾ç®€ä½“ç§¯ï¼Œç¨³å®šè¿è¡Œ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
