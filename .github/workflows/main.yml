# å·¥ä½œæµåç§°
name: Build Thunder Timecloud OpenWrt

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ + ä¿®æ”¹configæ–‡ä»¶è‡ªåŠ¨è§¦å‘
on:
  push:
    branches: [ main ]
    paths:
      - '.config'          # ä»…ä¿®æ”¹é…ç½®æ–‡ä»¶æ—¶è§¦å‘
      - 'configs/*'        # é…ç½®æ–‡ä»¶ç›®å½•å˜æ›´ä¹Ÿè§¦å‘
      - '.github/workflows/build.yml' # è„šæœ¬æœ¬èº«å˜æ›´è§¦å‘
  workflow_dispatch:        # æ‰‹åŠ¨è§¦å‘ï¼ˆæ ¸å¿ƒï¼Œæ–¹ä¾¿è°ƒè¯•ï¼‰
    inputs:
      openwrt_version:
        description: 'OpenWrtç‰ˆæœ¬ï¼ˆå¯é€‰ï¼š21.02.7/22.03/23.05ï¼‰'
        required: true
        default: '21.02.7'  # é»˜è®¤21.02.7ï¼Œé€‚é…è€è®¾å¤‡å…¼å®¹æ€§
        type: choice
        options:
          - 21.02.7
          - 22.03
          - 23.05

# ä½œä¸šé…ç½®
jobs:
  build-openwrt:
    runs-on: ubuntu-22.04  # ç¼–è¯‘ç¯å¢ƒï¼ˆå›ºå®šç”¨22.04ï¼Œå…¼å®¹æ€§æœ€ä½³ï¼‰
    permissions:
      contents: write      # å…è®¸ä¸Šä¼ å›ºä»¶åˆ°GitHub Releases
      actions: read

    # æ­¥éª¤å®šä¹‰
    steps:
      # æ­¥éª¤1ï¼šæ£€æŸ¥ä»£ç åˆ°å·¥ä½œç›®å½•
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # æ­¥éª¤2ï¼šå®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆOpenWrtç¼–è¯‘å¿…å¤‡ï¼‰
      - name: Install Build Dependencies
        run: |
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget \
            libelf-dev libtool-bin autoconf automake texinfo patch pkg-config libglib2.0-dev \
            libfuse-dev libssl-dev swig python3-pip
          sudo apt autoremove -y
          sudo apt clean -y

      # æ­¥éª¤3ï¼šç¼“å­˜ç¼–è¯‘ä¾èµ–ï¼ˆå¤§å¹…ç¼©çŸ­åç»­ç¼–è¯‘æ—¶é—´ï¼‰
      - name: Cache Build Files
        uses: actions/cache@v3
        with:
          path: |
            ./dl               # ç¼“å­˜ä¸‹è½½çš„æºç åŒ…
            ./staging_dir      # ç¼“å­˜ç¼–è¯‘ä¸­é—´æ–‡ä»¶
            ./feeds            # ç¼“å­˜æ’ä»¶æº
          key: ${{ runner.os }}-timecloud-${{ github.event.inputs.openwrt_version }}-${{ hashFiles('.config') }}
          restore-keys: |
            ${{ runner.os }}-timecloud-${{ github.event.inputs.openwrt_version }}-
            ${{ runner.os }}-timecloud-

      # æ­¥éª¤4ï¼šæ‹‰å–å¯¹åº”ç‰ˆæœ¬OpenWrtæºç ï¼ˆé‡ç‚¹é€‚é…21.02.7ï¼‰
      - name: Clone OpenWrt Source Code
        run: |
          # æ¸…ç©ºæ—§æºç ï¼ˆé¿å…å†²çªï¼‰
          rm -rf openwrt && mkdir openwrt && cd openwrt
          # æ‹‰å–å¯¹åº”ç‰ˆæœ¬æºç 
          if [ "${{ github.event.inputs.openwrt_version }}" = "21.02.7" ]; then
            # 21.02.7 å®˜æ–¹æºç ï¼ˆtagç‰ˆæœ¬ï¼‰
            git clone -b v21.02.7 --depth=1 https://github.com/openwrt/openwrt.git .
            # 21.02.7 éœ€æ‰‹åŠ¨æ›´æ–°feedsï¼ˆæ—§ç‰ˆæœ¬é»˜è®¤æºå¯èƒ½å¤±æ•ˆï¼‰
            sed -i 's#src-git packages #src-git packages https://github.com/openwrt/packages.git^openwrt-21.02 #' feeds.conf.default
            sed -i 's#src-git luci #src-git luci https://github.com/openwrt/luci.git^openwrt-21.02 #' feeds.conf.default
          elif [ "${{ github.event.inputs.openwrt_version }}" = "22.03" ]; then
            git clone -b openwrt-22.03 --depth=1 https://github.com/openwrt/openwrt.git .
          elif [ "${{ github.event.inputs.openwrt_version }}" = "23.05" ]; then
            git clone -b openwrt-23.05 --depth=1 https://github.com/openwrt/openwrt.git .
          fi
          # æ›´æ–°æ’ä»¶æºï¼ˆå…¨ç‰ˆæœ¬é€šç”¨ï¼‰
          ./scripts/feeds update -a

      # æ­¥éª¤5ï¼šå¯¼å…¥å®šåˆ¶é…ç½®æ–‡ä»¶ï¼ˆé€‚é…21.02.7çš„fw3é˜²ç«å¢™ï¼‰
      - name: Import Custom Config
        run: |
          cd openwrt
          # å¤åˆ¶ä»“åº“ä¸­çš„.configåˆ°æºç ç›®å½•
          cp $GITHUB_WORKSPACE/.config ./.config
          
          # 21.02.7 ä¸“å±é€‚é…ï¼šæ›¿æ¢fw4ä¸ºfw3ï¼ˆ21.02é»˜è®¤ç”¨fw3ï¼‰
          if [ "${{ github.event.inputs.openwrt_version }}" = "21.02.7" ]; then
            sed -i 's/CONFIG_PACKAGE_fw4=y/CONFIG_PACKAGE_fw3=y/' .config
            sed -i 's/CONFIG_PACKAGE_iptables-nft=y/CONFIG_PACKAGE_iptables=y/' .config
            sed -i '/CONFIG_PACKAGE_nftables=y/d' .config
          fi
          
          # å®‰è£…æ’ä»¶ï¼ˆé€‚é…Transmission/Sambaï¼‰
          ./scripts/feeds install -a
          # åŠ è½½é…ç½®ï¼ˆè‡ªåŠ¨è¡¥å…¨ä¾èµ–ï¼‰
          make defconfig

      # æ­¥éª¤6ï¼šå¼€å§‹ç¼–è¯‘å›ºä»¶
      - name: Build OpenWrt Firmware
        run: |
          cd openwrt
          # ä¸‹è½½ä¾èµ–åŒ…ï¼ˆé¿å…ç¼–è¯‘ä¸­æ–­ï¼‰
          make -j$(nproc) download V=s
          # ç¼–è¯‘å›ºä»¶ï¼ˆ-jå‚æ•°é€‚é…CPUæ ¸å¿ƒæ•°ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹é‡è¯•ï¼‰
          make -j$(nproc) V=s || make -j1 V=s
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          ls -lh bin/targets/ramips/mt7621/

      # æ­¥éª¤7ï¼šä¸Šä¼ å›ºä»¶ä¸ºArtifactsï¼ˆä¸´æ—¶ä¸‹è½½ï¼Œä¿ç•™30å¤©ï¼‰
      - name: Upload Firmware to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Timecloud-OpenWrt-${{ github.event.inputs.openwrt_version }}
          path: openwrt/bin/targets/ramips/mt7621/
          retention-days: 30

      # æ­¥éª¤8ï¼šä¸Šä¼ å›ºä»¶åˆ°GitHub Releasesï¼ˆæ°¸ä¹…ä¿å­˜ï¼Œä»…æ‰‹åŠ¨è§¦å‘ï¼‰
      - name: Upload Firmware to Releases
        if: github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: Timecloud-${{ github.event.inputs.openwrt_version }}-${{ github.run_id }}
          name: Timecloud OpenWrt ${{ github.event.inputs.openwrt_version }}
          files: openwrt/bin/targets/ramips/mt7621/*.bin
          body: |
            ğŸ“¦ Thunder Timecloud å®šåˆ¶å›ºä»¶
            - OpenWrtç‰ˆæœ¬ï¼š${{ github.event.inputs.openwrt_version }}
            - é¢„è£…åŠŸèƒ½ï¼šTransmission + Samba4 + ä¸­æ–‡LuCI
            - é€‚é…ç¡¬ä»¶ï¼š16Mé—ªå­˜ + 128Må†…å­˜
            - é˜²ç«å¢™ï¼š${{ github.event.inputs.openwrt_version == '21.02.7' && 'fw3' || 'fw4' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
